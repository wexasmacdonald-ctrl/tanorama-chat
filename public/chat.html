<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat</title>
    <style>
      :root {
        color-scheme: light dark;
        --chat-accent: #e11d48;
        --chat-bg: #ffffff;
        --chat-bg-muted: #fff1f2;
        --chat-border: #fed7e2;
        --chat-text: #1f2937;
        --chat-text-light: #6b7280;
        --chat-error: #dc2626;
        --chat-font: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: linear-gradient(180deg, #fff7fb 0%, #ffffff 38%, #fff1f4 100%);
        font-family: var(--chat-font);
        color: var(--chat-text);
        -webkit-font-smoothing: antialiased;
      }

      body {
        background: transparent;
        min-height: 100%;
        display: flex;
        align-items: stretch;
        justify-content: center;
      }

      .chat-shell {
        width: min(380px, 100vw);
        height: min(520px, 96vh);
        display: flex;
        flex-direction: column;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 18px 44px rgba(225, 29, 72, 0.24);
        border: 1px solid rgba(225, 29, 72, 0.18);
        background: var(--chat-bg);
      }

      @media (max-width: 480px) {
        .chat-shell {
          width: min(96vw, 420px);
          height: min(70vh, 520px);
          border-radius: 16px;
        }
      }

      .chat-header {
        background: var(--chat-accent);
        color: #ffffff;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.22);
      }

      .chat-title {
        font-size: 17px;
        font-weight: 700;
        margin: 0;
        max-width: 85%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .chat-close {
        appearance: none;
        border: none;
        background: rgba(255, 255, 255, 0.18);
        color: inherit;
        border-radius: 999px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: background 0.2s ease;
      }

      .chat-close:hover,
      .chat-close:focus-visible {
        background: rgba(255, 255, 255, 0.32);
        outline: none;
      }

      .chat-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: linear-gradient(180deg, #ffffff 0%, #fff7fb 52%, #fff1f2 100%);
      }

      .message {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .message[data-role="user"] .bubble {
        background: var(--chat-accent);
        color: #ffffff;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }

      .message[data-role="assistant"] .bubble {
        background: var(--chat-bg-muted);
        color: var(--chat-text);
        border: 1px solid rgba(225, 29, 72, 0.08);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }

      .message[data-role="system"] .bubble {
        background: transparent;
        color: var(--chat-text-light);
        font-size: 13px;
        align-self: center;
      }

      .bubble {
        padding: 10px 12px;
        border-radius: 12px;
        line-height: 1.4;
        max-width: 92%;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 14px;
      }

      .status {
        font-size: 12px;
        color: var(--chat-text-light);
        text-align: center;
      }

      .typing-indicator {
        display: inline-flex;
        gap: 3px;
        align-items: center;
      }

      .typing-dot {
        width: 6px;
        height: 6px;
        background: var(--chat-text-light);
        border-radius: 999px;
        animation: typing 1.2s infinite ease-in-out;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: translateY(0);
          opacity: 0.4;
        }
        40% {
          transform: translateY(-2px);
          opacity: 1;
        }
      }

      .chat-form {
        border-top: 1px solid var(--chat-border);
        padding: 12px;
        background: var(--chat-bg);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .chat-input {
        width: 100%;
        min-height: 48px;
        max-height: 150px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--chat-border);
        resize: none;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.4;
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }

      .chat-input:focus-visible {
        outline: none;
        border-color: var(--chat-accent);
        box-shadow: 0 0 0 2px rgba(29, 78, 216, 0.15);
      }

      .actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .error-banner {
        color: var(--chat-error);
        font-size: 13px;
        min-height: 18px;
      }

      .send-button {
        appearance: none;
        border: none;
        background: var(--chat-accent);
        color: #ffffff;
        border-radius: 999px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .send-button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .footer {
        font-size: 11px;
        color: var(--chat-text-light);
        text-align: center;
        padding-bottom: 4px;
      }

      .footer a {
        color: inherit;
        text-decoration: none;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="chat-shell" role="dialog" aria-modal="true" aria-label="Chat assistant">
      <header class="chat-header">
        <h1 class="chat-title">Assistant</h1>
        <button class="chat-close" type="button" aria-label="Close chat">Close</button>
      </header>
      <div class="chat-body">
        <div class="messages" id="messages" aria-live="polite"></div>
        <form class="chat-form" id="chat-form">
          <textarea
            id="chat-input"
            class="chat-input"
            name="message"
            placeholder="Type a message..."
            rows="2"
            aria-label="Message the assistant"
            required
          ></textarea>
          <div class="actions">
            <div class="error-banner" id="error-banner" role="alert"></div>
            <button class="send-button" type="submit">Send</button>
          </div>
        </form>
      </div>
      <div class="footer">Powered by MacDonald Automation</div>
    </div>
    <script>
      (function () {
        const params = new URLSearchParams(window.location.search || "");
        const upperFirst = (value) =>
          value ? value.charAt(0).toUpperCase() + value.slice(1) : value;

        const siteId = (params.get("siteId") || "tanorama").trim() || "tanorama";
        const title = params.get("title") ? params.get("title").trim() : "";
        const accent = params.get("accent") ? params.get("accent").trim() : "";
        const welcome = params.get("welcome") ? params.get("welcome").trim() : "";
        const token = params.get("token") ? params.get("token").trim() : null;

        const chatShell = document.querySelector(".chat-shell");
        const headerTitle = document.querySelector(".chat-title");
        const closeButton = document.querySelector(".chat-close");
        const form = document.getElementById("chat-form");
        const textarea = document.getElementById("chat-input");
        const messagesEl = document.getElementById("messages");
        const errorBanner = document.getElementById("error-banner");
        const sendButton = form.querySelector(".send-button");

        const defaultAccent = getComputedStyle(document.documentElement)
          .getPropertyValue("--chat-accent")
          .trim();
        const accentRegex = /^#([0-9a-fA-F]{6})$/;
        const appliedAccent = accentRegex.test(accent) ? accent : defaultAccent;
        document.documentElement.style.setProperty("--chat-accent", appliedAccent);

        const fallbackTitle =
          siteId.toLowerCase() === "tanorama"
            ? "Tanorama Assistant"
            : upperFirst(siteId.replace(/[-_]/g, " "));
        headerTitle.textContent = title || fallbackTitle;

        const sessionId =
          (typeof crypto !== "undefined" && crypto.randomUUID
            ? crypto.randomUUID()
            : Math.random().toString(36).slice(2, 10)) + "-" + Date.now();

        const state = {
          messages: [],
          pending: false,
          typing: false,
        };

        if (welcome) {
          state.messages.push({
            role: "assistant",
            content: welcome,
            id: "welcome",
          });
        }

        function scrollToBottom() {
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function createMessageElement(message) {
          const wrapper = document.createElement("div");
          wrapper.className = "message";
          wrapper.dataset.role = message.role;

          const bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.textContent = message.content;
          wrapper.appendChild(bubble);
          return wrapper;
        }

        function renderMessages() {
          messagesEl.innerHTML = "";
          state.messages.forEach((msg) => {
            messagesEl.appendChild(createMessageElement(msg));
          });

          if (state.typing) {
            const typingWrapper = document.createElement("div");
            typingWrapper.className = "message";
            typingWrapper.dataset.role = "assistant";

            const typingBubble = document.createElement("div");
            typingBubble.className = "bubble";
            const typingInner = document.createElement("span");
            typingInner.className = "typing-indicator";
            typingInner.innerHTML =
              '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            typingBubble.appendChild(typingInner);
            typingWrapper.appendChild(typingBubble);
            messagesEl.appendChild(typingWrapper);
          }

          requestAnimationFrame(scrollToBottom);
        }

        function setError(message) {
          errorBanner.textContent = message || "";
        }

        function setPending(pending) {
          state.pending = pending;
          textarea.disabled = pending;
          sendButton.disabled = pending;
        }

        function clearInput() {
          textarea.value = "";
          textarea.style.height = "auto";
        }

        function postCloseMessage(reason) {
          try {
            window.parent.postMessage(
              { source: "macautomation-chat", type: "close", reason: reason || "user" },
              "*"
            );
          } catch (_) {
            /* no-op */
          }
        }

        function sanitizeMessage(value) {
          if (!value) return "";
          const normalized = value.replace(/\r\n/g, "\n");
          return normalized.trim();
        }

        function updateTextareaHeight() {
          textarea.style.height = "auto";
          textarea.style.height = Math.min(textarea.scrollHeight, 150) + "px";
        }

        textarea.addEventListener("input", updateTextareaHeight);
        updateTextareaHeight();

        closeButton.addEventListener("click", function () {
          postCloseMessage("close-button");
        });

        window.addEventListener("keydown", function (event) {
          if (event.key === "Escape") {
            event.stopPropagation();
            event.preventDefault();
            postCloseMessage("escape-key");
          }
        });

        form.addEventListener("keydown", function (event) {
          if (event.key === "Enter" && !event.shiftKey) {
            const isTextarea = event.target === textarea;
            if (isTextarea) {
              event.preventDefault();
              form.requestSubmit();
            }
          }
        });

        form.addEventListener("submit", async function (event) {
          event.preventDefault();
          if (state.pending) return;

          setError("");

          const rawMessage = textarea.value;
          const message = sanitizeMessage(rawMessage);

          if (!message) {
            setError("Please enter a message.");
            return;
          }

          if (message.length > 1500) {
            setError("Please shorten your message and try again.");
            return;
          }

          const userMessage = {
            role: "user",
            content: message,
            id: "user-" + Date.now(),
          };

          state.messages.push(userMessage);
          clearInput();
          renderMessages();

          const history = state.messages
            .slice(0, -1)
            .filter((msg) => msg.role === "user" || msg.role === "assistant")
            .map((msg) => ({ role: msg.role, content: msg.content }))
            .slice(-10);

          state.typing = true;
          renderMessages();
          setPending(true);

          try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 1000 * 60);
            const headers = {
              "Content-Type": "application/json",
              "X-Chat-Site": siteId,
            };
            if (token) {
              headers["Authorization"] = "Bearer " + token;
            }

            const response = await fetch("/api/chat", {
              method: "POST",
              headers,
              body: JSON.stringify({
                message,
                history,
                siteId,
                sessionId,
              }),
              signal: controller.signal,
            });
            clearTimeout(timeout);

            const data = await response.json().catch(() => ({}));

            if (!response.ok) {
              const fallback =
                data && data.error
                  ? data.error
                  : "Something went wrong. Try again shortly.";
              setError(fallback);
            } else {
              const reply =
                data && typeof data.reply === "string"
                  ? data.reply.trim()
                  : "I’m not sure how to respond to that.";

              state.messages.push({
                role: "assistant",
                content: reply,
                id: "assistant-" + Date.now(),
              });
              setError("");
            }
          } catch (error) {
            if (error && error.name === "AbortError") {
              setError("Something took too long. Try again shortly.");
            } else {
              setError("Something went wrong. Try again shortly.");
            }
          } finally {
            state.typing = false;
            setPending(false);
            renderMessages();
            textarea.focus();
          }
        });

        renderMessages();

        window.requestAnimationFrame(() => {
          textarea.focus();
        });
      })();
    </script>
  </body>
</html>
