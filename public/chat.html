<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat</title>
    <style>
      :root {
        color-scheme: light;
        --chat-accent: #000000;
        --chat-bg: #ffffff;
        --chat-bg-muted: #ffffff;
        --chat-border: #000000;
        --chat-text: #000000;
        --chat-text-light: #000000;
        --chat-error: #000000;
        --chat-font: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        font-family: var(--chat-font);
        color: var(--chat-text);
        -webkit-font-smoothing: antialiased;
      }

      body {
        background: transparent;
        min-height: 100%;
        display: flex;
        align-items: stretch;
        justify-content: center;
      }

      .chat-frame {
        width: 100%;
        height: 100%;
        border: 3px solid #000000;
        border-radius: 15px;
        overflow: hidden;
        display: flex;
      }

      .chat-shell {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        border-radius: 0;
        overflow: hidden;
        background: var(--chat-bg);
      }

      @media (max-width: 480px) {
        .chat-frame {
          border-radius: 15px;
        }
      }

      .chat-header {
        background: #000000;
        color: #ffffff;
        padding: 14px 20px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 12px;
      }

      .chat-title {
        font-size: 17px;
        font-weight: 400;
        margin: 0;
        max-width: 85%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .chat-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding-bottom: 48px;
        position: relative;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: var(--chat-bg);
      }

      .message {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .message[data-role="user"] .bubble {
        background: var(--chat-accent);
        color: #ffffff;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }

      .message[data-role="assistant"] .bubble {
        background: var(--chat-bg-muted);
        color: var(--chat-text);
        border: 1px solid var(--chat-border);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }

      .message[data-role="system"] .bubble {
        background: transparent;
        color: var(--chat-text-light);
        font-size: 13px;
        align-self: center;
      }

      .bubble {
        padding: 10px 12px;
        border-radius: 12px;
        line-height: 1.4;
        max-width: 92%;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 14px;
      }

      .bubble p {
        margin: 0 0 8px;
        white-space: normal;
      }

      .bubble p:last-child {
        margin-bottom: 0;
      }

      .bubble figure {
        margin: 8px 0 0;
      }

      .bubble figure:first-child {
        margin-top: 0;
      }

      .bubble figure:last-child {
        margin-bottom: 0;
      }

      .bubble img {
        display: block;
        max-width: 100%;
        border-radius: 10px;
        box-shadow: none;
      }

      .status {
        font-size: 12px;
        color: var(--chat-text-light);
        text-align: center;
      }

      .typing-indicator {
        display: inline-flex;
        gap: 3px;
        align-items: center;
      }

      .typing-dot {
        width: 6px;
        height: 6px;
        background: var(--chat-text-light);
        border-radius: 999px;
        animation: typing 1.2s infinite ease-in-out;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: translateY(0);
          opacity: 0.4;
        }
        40% {
          transform: translateY(-2px);
          opacity: 1;
        }
      }

      .chat-form {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        border-top: 1px solid var(--chat-border);
        padding: 12px 12px 8px;
        background: var(--chat-bg);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .chat-input {
        width: 100%;
        min-height: 48px;
        max-height: 150px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--chat-border);
        resize: none;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.4;
        transition: border 0.2s ease, box-shadow 0.2s ease;
        background: #ffffff;
        color: var(--chat-text);
      }

      .chat-input::placeholder {
        color: rgba(10, 31, 68, 0.5);
      }

      .chat-input:focus-visible {
        outline: none;
        border-color: var(--chat-accent);
        box-shadow: 0 0 0 2px rgba(10, 31, 68, 0.15);
      }

      .error-banner {
        color: var(--chat-error);
        font-size: 13px;
        min-height: 18px;
      }

      .send-button {
        appearance: none;
        border: none;
        background: var(--chat-accent);
        color: #ffffff;
        border-radius: 10px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .send-button:hover,
      .send-button:focus-visible {
        opacity: 0.9;
        transform: none;
      }

      .send-button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .chat-footer {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        font-size: 11px;
        color: var(--chat-text-light);
        text-align: left;
      }

      .footer-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .footer-left a {
        color: inherit;
        text-decoration: none;
      }

      .footer-left a:hover,
      .footer-left a:focus-visible {
        text-decoration: underline;
        outline: none;
      }

    </style>
  </head>
  <body>
    <div class="chat-frame">
      <div class="chat-shell" role="dialog" aria-modal="true" aria-label="Chat assistant">
        <header class="chat-header">
          <h1 class="chat-title">Assistant</h1>
        </header>
        <div class="chat-body">
          <div class="messages" id="messages" aria-live="polite"></div>
          <form class="chat-form" id="chat-form">
            <textarea
              id="chat-input"
              class="chat-input"
              name="message"
              placeholder="Type a message..."
              rows="2"
              aria-label="Message the assistant"
              required
            ></textarea>
            <div class="chat-footer">
              <div class="footer-left">
                <a href="https://macdonaldautomation.com" target="_blank" rel="noopener noreferrer">
                  Powered by MacDonald AI
                </a>
                <div class="error-banner" id="error-banner" role="alert"></div>
              </div>
              <button class="send-button" type="submit">Send</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script>
      (function () {
        const params = new URLSearchParams(window.location.search || "");
        const upperFirst = (value) =>
          value ? value.charAt(0).toUpperCase() + value.slice(1) : value;

        const siteId = (params.get("siteId") || "tanorama").trim() || "tanorama";
        const title = params.get("title") ? params.get("title").trim() : "";
        const welcome = params.get("welcome") ? params.get("welcome").trim() : "";
        const token = params.get("token") ? params.get("token").trim() : null;

        const chatShell = document.querySelector(".chat-shell");
        const headerTitle = document.querySelector(".chat-title");
        const form = document.getElementById("chat-form");
        const textarea = document.getElementById("chat-input");
        const messagesEl = document.getElementById("messages");
        const errorBanner = document.getElementById("error-banner");
        const sendButton = form.querySelector(".send-button");

        const appliedAccent = "#000000";
        document.documentElement.style.setProperty("--chat-accent", appliedAccent);

        const fallbackTitle =
          siteId.toLowerCase() === "tanorama"
            ? "Tanorama Assistant"
            : upperFirst(siteId.replace(/[-_]/g, " "));
        headerTitle.textContent = title || fallbackTitle;

        const sessionId =
          (typeof crypto !== "undefined" && crypto.randomUUID
            ? crypto.randomUUID()
            : Math.random().toString(36).slice(2, 10)) + "-" + Date.now();

        const state = {
          messages: [],
          pending: false,
          typing: false,
        };

        const defaultSalutation = "Ask me anything about our services!";
        const welcomeMessage = welcome || defaultSalutation;

        if (welcomeMessage) {
          state.messages.push({
            role: "assistant",
            content: welcomeMessage,
            id: "welcome",
          });
        }

        function scrollToBottom() {
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        const ALLOWED_IMAGE_HOSTS = new Set(["static.wixstatic.com"]);
        const ALLOWED_LINK_HOSTS = new Set(["tanorama.ca", "www.tanorama.ca", "calendly.com"]);

        function isAllowedHost(url, allowedHosts) {
          try {
            const parsed = new URL(url);
            return allowedHosts.has(parsed.hostname);
          } catch (_) {
            return false;
          }
        }

        function appendInlineContent(container, text) {
          const linkRegex = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;
          let lastIndex = 0;
          let match;
          while ((match = linkRegex.exec(text))) {
            const preceding = text.slice(lastIndex, match.index);
            if (preceding) {
              container.appendChild(document.createTextNode(preceding));
            }

            const label = match[1];
            const href = match[2];
            if (isAllowedHost(href, ALLOWED_LINK_HOSTS)) {
              const anchor = document.createElement("a");
              anchor.href = href;
              anchor.textContent = label;
              anchor.target = "_blank";
              anchor.rel = "noopener noreferrer";
              container.appendChild(anchor);
            } else {
              container.appendChild(document.createTextNode(match[0]));
            }
            lastIndex = match.index + match[0].length;
          }

          const trailing = text.slice(lastIndex);
          if (trailing) {
            container.appendChild(document.createTextNode(trailing));
          }
        }

        function renderMessageContent(rawContent) {
          const content = typeof rawContent === "string" ? rawContent : "";
          const fragment = document.createDocumentFragment();
          const blocks = content.split(/\n{2,}/);

          for (const block of blocks) {
            const trimmed = block.trim();
            if (!trimmed) {
              continue;
            }

            const imageMatch = trimmed.match(/^!\[([^\]]*)\]\((https?:\/\/[^\s)]+)\)$/);
            if (imageMatch && isAllowedHost(imageMatch[2], ALLOWED_IMAGE_HOSTS)) {
              const figure = document.createElement("figure");
              figure.className = "chat-image";
              const img = document.createElement("img");
              img.src = imageMatch[2];
              img.alt = imageMatch[1] || "";
              img.loading = "lazy";
              figure.appendChild(img);
              fragment.appendChild(figure);
              continue;
            }

            const paragraph = document.createElement("p");
            const lines = block.split("\n");
            lines.forEach((line, index) => {
              appendInlineContent(paragraph, line);
              if (index < lines.length - 1) {
                paragraph.appendChild(document.createElement("br"));
              }
            });
            fragment.appendChild(paragraph);
          }

          if (!fragment.childNodes.length) {
            fragment.appendChild(document.createTextNode(content));
          }

          return fragment;
        }

        function createMessageElement(message) {
          const wrapper = document.createElement("div");
          wrapper.className = "message";
          wrapper.dataset.role = message.role;

          const bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.appendChild(renderMessageContent(message.content));
          wrapper.appendChild(bubble);
          return wrapper;
        }

        function renderMessages() {
          messagesEl.innerHTML = "";
          state.messages.forEach((msg) => {
            messagesEl.appendChild(createMessageElement(msg));
          });

          if (state.typing) {
            const typingWrapper = document.createElement("div");
            typingWrapper.className = "message";
            typingWrapper.dataset.role = "assistant";

            const typingBubble = document.createElement("div");
            typingBubble.className = "bubble";
            const typingInner = document.createElement("span");
            typingInner.className = "typing-indicator";
            typingInner.innerHTML =
              '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            typingBubble.appendChild(typingInner);
            typingWrapper.appendChild(typingBubble);
            messagesEl.appendChild(typingWrapper);
          }

          requestAnimationFrame(scrollToBottom);
        }

        function setError(message) {
          errorBanner.textContent = message || "";
        }

        function setPending(pending) {
          state.pending = pending;
          textarea.disabled = pending;
          sendButton.disabled = pending;
        }

        function clearInput() {
          textarea.value = "";
          textarea.style.height = "auto";
        }

        function postCloseMessage(reason) {
          try {
            window.parent.postMessage(
              { source: "macautomation-chat", type: "close", reason: reason || "user" },
              "*"
            );
          } catch (_) {
            /* no-op */
          }
        }

        function sanitizeMessage(value) {
          if (!value) return "";
          const normalized = value.replace(/\r\n/g, "\n");
          return normalized.trim();
        }

        function updateTextareaHeight() {
          textarea.style.height = "auto";
          textarea.style.height = Math.min(textarea.scrollHeight, 150) + "px";
        }

        textarea.addEventListener("input", updateTextareaHeight);
        updateTextareaHeight();

        window.addEventListener("keydown", function (event) {
          if (event.key === "Escape") {
            event.stopPropagation();
            event.preventDefault();
            postCloseMessage("escape-key");
          }
        });

        form.addEventListener("keydown", function (event) {
          if (event.key === "Enter" && !event.shiftKey) {
            const isTextarea = event.target === textarea;
            if (isTextarea) {
              event.preventDefault();
              form.requestSubmit();
            }
          }
        });

        form.addEventListener("submit", async function (event) {
          event.preventDefault();
          if (state.pending) return;

          setError("");

          const rawMessage = textarea.value;
          const message = sanitizeMessage(rawMessage);

          if (!message) {
            setError("Please enter a message.");
            return;
          }

          if (message.length > 1500) {
            setError("Please shorten your message and try again.");
            return;
          }

          const userMessage = {
            role: "user",
            content: message,
            id: "user-" + Date.now(),
          };

          state.messages.push(userMessage);
          clearInput();
          renderMessages();

          const history = state.messages
            .slice(0, -1)
            .filter((msg) => msg.role === "user" || msg.role === "assistant")
            .map((msg) => ({ role: msg.role, content: msg.content }))
            .slice(-10);

          state.typing = true;
          renderMessages();
          setPending(true);

          try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 1000 * 60);
            const headers = {
              "Content-Type": "application/json",
              "X-Chat-Site": siteId,
            };
            if (token) {
              headers["Authorization"] = "Bearer " + token;
            }

            const response = await fetch("/api/chat", {
              method: "POST",
              headers,
              body: JSON.stringify({
                message,
                history,
                siteId,
                sessionId,
              }),
              signal: controller.signal,
            });
            clearTimeout(timeout);

            const data = await response.json().catch(() => ({}));

            if (!response.ok) {
              const fallback =
                data && data.error
                  ? data.error
                  : "Something went wrong. Try again shortly.";
              setError(fallback);
            } else {
              const reply =
                data && typeof data.reply === "string"
                  ? data.reply.trim()
                  : "I’m not sure about that one. Please call 365-994-5394, email corbin@tanorama.ca, or use the contact form at tanorama.ca/bookings and we’ll help you directly.";

              state.messages.push({
                role: "assistant",
                content: reply,
                id: "assistant-" + Date.now(),
              });
              setError("");
            }
          } catch (error) {
            if (error && error.name === "AbortError") {
              setError("Something took too long. Try again shortly.");
            } else {
              setError("Something went wrong. Try again shortly.");
            }
          } finally {
            state.typing = false;
            setPending(false);
            renderMessages();
            textarea.focus();
          }
        });

        renderMessages();

        window.requestAnimationFrame(() => {
          textarea.focus();
        });
      })();
    </script>
  </body>
</html>
